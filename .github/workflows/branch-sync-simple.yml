name: Branch Synchronization

on:
  workflow_run:
    workflows: ["Build and Test MacForge", "Swift CI"]
    types: [completed]
    branches: [main]

jobs:
  sync-development-branch:
    name: Sync Development Branch
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Check if development branch exists
      run: |
        echo "Checking for development branch..."
        if git show-ref --verify --quiet refs/remotes/origin/development; then
          echo "Development branch exists"
          echo "DEVELOPMENT_EXISTS=true" >> $GITHUB_ENV
        else
          echo "Development branch does not exist - skipping sync"
          echo "DEVELOPMENT_EXISTS=false" >> $GITHUB_ENV
        fi
    
    - name: Sync development branch
      if: env.DEVELOPMENT_EXISTS == 'true'
      run: |
        echo "Syncing development branch with main..."
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        
        git checkout development
        git pull origin development
        git merge origin/main --no-edit || echo "Merge conflicts detected - manual intervention required"
        git push origin development || echo "Push failed - manual intervention required"
        echo "Development branch sync completed"
